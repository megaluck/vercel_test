<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>21M With Privacy — Embedded Chat (BM25 RAG + Citations + Debug)</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root { --ink:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#cbd5e1; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#fff}
    header{padding:48px 20px 24px;text-align:center}
    h1{margin:0 0 10px;font-size:clamp(28px,4vw,44px)}
    p.lead{margin:0 auto;max-width:900px;color:#cbd5e1}
    main{padding:40px 20px 80px;display:grid;gap:24px;place-items:center}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px;max-width:1000px;width:100%}
    .card p{color:var(--muted);margin:0}
    .chat-container{max-width:1000px;width:100%}
    .chat-panel{display:flex;flex-direction:column;overflow:hidden;width:100%;height:clamp(460px,70vh,720px);background:#fff;color:#111;border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 20px 40px rgba(0,0,0,.35)}
    .chat-header{padding:10px 12px;background:#0b1220;color:#fff;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .chat-header-left{display:flex;align-items:center;gap:10px}
    .status-dot{width:9px;height:9px;border-radius:999px;background:#999}
    .status-ok{background:#22c55e}.status-bad{background:#ef4444}
    .model-badge{font-size:12px;opacity:.85}
    .chat-actions{display:flex;gap:6px}
    .chat-iconbtn{background:transparent;border:0;color:#fff;opacity:.9;cursor:pointer;font-size:16px;line-height:1;padding:4px 6px;border-radius:6px}
    .chat-iconbtn:hover{opacity:1;background:rgba(255,255,255,.12)}
    .chat-body{padding:12px;overflow:auto;gap:8px;display:flex;flex-direction:column;flex:1;background:#fafafa}
    .chat-msg{padding:8px 10px;border-radius:10px;max-width:85%;white-space:pre-wrap;word-wrap:break-word}
    .chat-user{align-self:flex-end;background:#e6f0ff}
    .chat-bot{align-self:flex-start;background:#f4f6f8}
    .sources-block{margin-top:4px;background:#eef2ff;border:1px solid #dbe3ff}
    .sources-title{font-weight:700;margin-bottom:6px}
    .source-item{font-size:12px;line-height:1.4;margin:2px 0}
    .source-score{opacity:.7}
    .chat-debug{display:none;border-top:1px dashed #e5e7eb;background:#f9fafb;color:#111;max-height:30vh;overflow:auto}
    .chat-debug pre{margin:0;padding:10px 12px;font:12px ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;word-wrap:break-word}
    .chat-debug .small{opacity:.8}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;background:#fff}
    .chat-input input{flex:1;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    .chat-input button{padding:12px 14px;border:0;border-radius:10px;background:#0b1220;color:#fff;font-weight:600;min-width:88px}
    .chat-input button[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <header>
    <h1>21M With Privacy</h1>
    <p class="lead">BM25 retrieval + prompt.txt. The bot answers from your knowledge base first and shows citations.</p>
  </header>

  <main>
    <section class="card">
      <p>Endpoints: <code>/api/chat?debug=1</code>, <code>/api/health</code>, and <code>/api/rag-debug</code>. Build the index with <code>node scripts/build-keyword-index.js</code>.</p>
    </section>

    <section class="chat-container">
      <div class="chat-panel" id="chat-panel" role="region" aria-label="Site assistant chat">
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="status-dot" id="chat-status" title="API status"></div>
            <div><strong>Ask me anything</strong> <span class="model-badge" id="model-badge"></span></div>
          </div>
          <div class="chat-actions">
            <button class="chat-iconbtn" id="chat-health" title="Health check">❤</button>
            <button class="chat-iconbtn" id="chat-toggle-debug" title="Toggle debug">⚙︎</button>
          </div>
        </div>

        <div class="chat-body" id="chat-body" aria-live="polite"></div>

        <div class="chat-debug" id="chat-debug">
          <pre id="chat-debug-pre" class="small">Debug off</pre>
        </div>

        <div class="chat-input">
          <input id="chat-input" type="text" placeholder="Type a message…" aria-label="Message" />
          <button id="chat-send">Send</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_CHAT = '/api/chat?debug=1';
    const API_HEALTH = '/api/health';

    const bodyEl = document.getElementById('chat-body');
    const inputEl = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send');
    const statusDot = document.getElementById('chat-status');
    const toggleDebugBtn = document.getElementById('chat-toggle-debug');
    const debugBox = document.getElementById('chat-debug');
    const debugPre = document.getElementById('chat-debug-pre');
    const healthBtn = document.getElementById('chat-health');
    const modelBadge = document.getElementById('model-badge');

    const messages = [{ role: 'system', content: 'You are a concise, friendly site assistant.' }];

    function addMsg(text, who, extraClass='') {
      const div = document.createElement('div');
      div.className = 'chat-msg ' + (who === 'user' ? 'chat-user' : 'chat-bot') + (extraClass ? (' ' + extraClass) : '');
      div.textContent = text;
      bodyEl.appendChild(div);
      bodyEl.scrollTop = bodyEl.scrollHeight;
      return div;
    }
    function setStatus(ok) {
      statusDot.classList.remove('status-ok','status-bad');
      statusDot.classList.add(ok ? 'status-ok' : 'status-bad');
    }
    function showDebug(obj) {
      debugPre.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }
    function formatServerError(status, data) {
      const parts = [];
      parts.push(`Server error (${status})`);
      if (data?.phase) parts.push(`phase: ${data.phase}`);
      if (data?.message) parts.push(`message: ${data.message}`);
      if (data?.requestId) parts.push(`requestId: ${data.requestId}`);
      if (data?.debug?.openai_status) parts.push(`openai_status: ${data.debug.openai_status}`);
      if (data?.debug?.stack_head) parts.push(`stack:\n${data.debug.stack_head}`);
      return parts.join('\n');
    }
    function renderSources(sources) {
      if (!Array.isArray(sources) || sources.length === 0) return;
      const wrap = document.createElement('div');
      wrap.className = 'chat-msg chat-bot sources-block';
      const title = document.createElement('div');
      title.className = 'sources-title';
      title.textContent = 'Sources used:';
      wrap.appendChild(title);

      sources.forEach((s, i) => {
        const line = document.createElement('div');
        line.className = 'source-item';
        line.textContent = `[#${i+1}] ${s.title} (${s.file}) — score `;
        const score = document.createElement('span');
        score.className = 'source-score';
        score.textContent = String(s.score);
        line.appendChild(score);
        wrap.appendChild(line);
      });

      bodyEl.appendChild(wrap);
      bodyEl.scrollTop = bodyEl.scrollHeight;
    }

    async function healthCheck() {
      try {
        const t0 = performance.now();
        const r = await fetch(API_HEALTH);
        const t1 = performance.now();
        const data = await r.json();
        setStatus(Boolean(data.hasKey));
        modelBadge.textContent = data.model ? `(${data.model})` : '';
        showDebug({ endpoint: 'health', httpStatus: r.status, latencyMs: Math.round(t1 - t0), data });
      } catch (e) {
        setStatus(false);
        showDebug({ endpoint: 'health', error: String(e) });
      }
    }

    async function send() {
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = '';
      addMsg(text, 'user');

      const placeholder = addMsg('…', 'bot');
      sendBtn.disabled = true;

      const payload = { messages: messages.concat({ role: 'user', content: text }) };
      const t0 = performance.now();

      try {
        const res = await fetch(API_CHAT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const t1 = performance.now();

        let data = {};
        try { data = await res.json(); } catch {}

        if (!res.ok) {
          placeholder.textContent = formatServerError(res.status, data);
          setStatus(false);
        } else {
          placeholder.textContent = data.reply || 'Sorry, no reply.';
          if (Array.isArray(data.sources) && data.sources.length) {
            renderSources(data.sources);
          } else {
            // make it obvious when no KB matched
            renderSources([{ title: 'No KB matches', file: '—', score: 0 }]);
          }
        }

        showDebug({
          endpoint: 'chat',
          httpStatus: res.status,
          latencyMs: Math.round(t1 - t0),
          data
        });

        if (data.reply) messages.push({ role: 'user', content: text }, { role: 'assistant', content: data.reply });
      } catch (e) {
        placeholder.textContent = `Network error: ${String(e)}`;
        setStatus(false);
        showDebug({ endpoint: 'chat', error: String(e) });
      } finally {
        sendBtn.disabled = false;
        bodyEl.scrollTop = bodyEl.scrollHeight;
      }
    }

    toggleDebugBtn.addEventListener('click', () => {
      const show = debugBox.style.display !== 'block';
      debugBox.style.display = show ? 'block' : 'none';
      if (show && debugPre.textContent === 'Debug off') showDebug('Debug on. Calls will print here.');
    });
    healthBtn.addEventListener('click', () => healthCheck());
    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });

    window.addEventListener('DOMContentLoaded', () => {
      addMsg("Hi! I answer using our knowledge base and will show citations below each answer. Ask me about Zcash, wallets, or #21MWithPrivacy.", 'bot');
      inputEl.focus();
      healthCheck();
    });
  </script>
</body>
</html>
