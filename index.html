<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>21M With Privacy — Embedded Chat</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root { --ink:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#cbd5e1; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#fff}

    header{padding:48px 20px 24px;text-align:center}
    h1{margin:0 0 10px;font-size:clamp(28px,4vw,44px)}
    p.lead{margin:0 auto;max-width:900px;color:#cbd5e1}

    main{padding:40px 20px 80px;display:grid;gap:24px;place-items:center}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px;max-width:1000px;width:100%}
    .card p{color:var(--muted);margin:0}

    /* Embedded chat box */
    .chat-container{max-width:1000px;width:100%}
    .chat-panel{
      display:flex;flex-direction:column;overflow:hidden;
      width:100%; height:clamp(460px, 70vh, 720px);
      background:#fff;color:#111;border-radius:16px;border:1px solid #e5e7eb;
      box-shadow:0 20px 40px rgba(0,0,0,.35);
    }
    .chat-header{
      padding:10px 12px;background:#0b1220;color:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:8px
    }
    .chat-header-left{display:flex;align-items:center;gap:10px}
    .status-dot{width:9px;height:9px;border-radius:999px;background:#999}
    .status-ok{background:#22c55e}.status-bad{background:#ef4444}
    .chat-actions{display:flex;gap:6px}
    .chat-iconbtn{
      background:transparent;border:0;color:#fff;opacity:.9;cursor:pointer;
      font-size:16px;line-height:1;padding:4px 6px;border-radius:6px
    }
    .chat-iconbtn:hover{opacity:1;background:rgba(255,255,255,.12)}
    .chat-body{
      padding:12px;overflow:auto;gap:8px;display:flex;flex-direction:column;flex:1; background:#fafafa
    }
    .chat-msg{padding:8px 10px;border-radius:10px;max-width:85%;white-space:pre-wrap;word-wrap:break-word}
    .chat-user{align-self:flex-end;background:#e6f0ff}
    .chat-bot{align-self:flex-start;background:#f4f6f8}
    .chat-debug{display:none;border-top:1px dashed #e5e7eb;background:#f9fafb;color:#111;max-height:30vh;overflow:auto}
    .chat-debug pre{margin:0;padding:10px 12px;font:12px ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap;word-wrap:break-word}
    .chat-debug .small{opacity:.8}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;background:#fff}
    .chat-input input{
      flex:1;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:14px
    }
    .chat-input button{
      padding:12px 14px;border:0;border-radius:10px;background:#0b1220;color:#fff;font-weight:600;min-width:88px
    }
    .chat-input button[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <header>
    <h1>21M With Privacy</h1>
    <p class="lead">Embedded chat assistant with serverless backend, health check, and a built-in debug drawer.</p>
  </header>

  <main>
    <section class="card">
      <p>This page embeds the chat directly in the content. The API lives at <code>/api/chat?debug=1</code> and <code>/api/health</code>. Keep your server files from before; no backend change needed.</p>
    </section>

    <section class="chat-container">
      <div class="chat-panel" id="chat-panel" role="region" aria-label="Site assistant chat">
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="status-dot" id="chat-status" title="API status"></div>
            <div><strong>Ask me anything</strong></div>
          </div>
          <div class="chat-actions">
            <button class="chat-iconbtn" id="chat-health" title="Health check">❤</button>
            <button class="chat-iconbtn" id="chat-toggle-debug" title="Toggle debug">⚙︎</button>
          </div>
        </div>

        <div class="chat-body" id="chat-body" aria-live="polite"></div>

        <div class="chat-debug" id="chat-debug">
          <pre id="chat-debug-pre" class="small">Debug off</pre>
        </div>

        <div class="chat-input">
          <input id="chat-input" type="text" placeholder="Type a message…" aria-label="Message" />
          <button id="chat-send">Send</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // --- Config ---
    const API_CHAT = '/api/chat?debug=1';
    const API_HEALTH = '/api/health';

    // --- Elements ---
    const panel = document.getElementById('chat-panel');
    const bodyEl = document.getElementById('chat-body');
    const inputEl = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send');
    const statusDot = document.getElementById('chat-status');
    const toggleDebugBtn = document.getElementById('chat-toggle-debug');
    const debugBox = document.getElementById('chat-debug');
    const debugPre = document.getElementById('chat-debug-pre');
    const healthBtn = document.getElementById('chat-health');

    // --- Conversation state ---
    const messages = [
      { role: 'system', content: 'You are a concise, friendly site assistant.' }
    ];

    // --- Helpers ---
    function addMsg(text, who) {
      const div = document.createElement('div');
      div.className = 'chat-msg ' + (who === 'user' ? 'chat-user' : 'chat-bot');
      div.textContent = text;
      bodyEl.appendChild(div);
      bodyEl.scrollTop = bodyEl.scrollHeight;
    }
    function setStatus(ok) {
      statusDot.classList.remove('status-ok','status-bad');
      statusDot.classList.add(ok ? 'status-ok' : 'status-bad');
    }
    function showDebug(obj) {
      debugPre.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    // --- API calls ---
    async function healthCheck() {
      try {
        const t0 = performance.now();
        const r = await fetch(API_HEALTH, { method: 'GET' });
        const t1 = performance.now();
        const data = await r.json();
        setStatus(Boolean(data.hasKey));
        showDebug({ endpoint: 'health', httpStatus: r.status, latencyMs: Math.round(t1 - t0), data });
        return data;
      } catch (e) {
        setStatus(false);
        showDebug({ endpoint: 'health', error: String(e) });
      }
    }

    async function send() {
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = '';
      addMsg(text, 'user');

      // typing placeholder
      addMsg('…', 'bot');
      sendBtn.disabled = true;

      const payload = { messages: messages.concat({ role: 'user', content: text }) };
      const t0 = performance.now();

      try {
        const res = await fetch(API_CHAT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const t1 = performance.now();
        const reqId = res.headers.get('x-request-id');

        let data = {};
        try { data = await res.json(); } catch {}

        if (!res.ok) {
          bodyEl.lastChild.textContent = `Server error: ${res.status}`;
          setStatus(false);
        } else {
          bodyEl.lastChild.textContent = data.reply || 'Sorry, no reply.';
        }

        // Show debug info
        showDebug({
          endpoint: 'chat',
          httpStatus: res.status,
          latencyMs: Math.round(t1 - t0),
          requestId: reqId,
          debug: data.debug || null
        });

        // Persist conversation
        if (data.reply) messages.push({ role: 'user', content: text }, { role: 'assistant', content: data.reply });
      } catch (e) {
        bodyEl.lastChild.textContent = 'Error talking to the bot. Is /api/chat deployed?';
        setStatus(false);
        showDebug({ endpoint: 'chat', error: String(e) });
      } finally {
        sendBtn.disabled = false;
        bodyEl.scrollTop = bodyEl.scrollHeight;
      }
    }

    // --- UI wiring ---
    toggleDebugBtn.addEventListener('click', () => {
      const show = debugBox.style.display !== 'block';
      debugBox.style.display = show ? 'block' : 'none';
      if (show && debugPre.textContent === 'Debug off') showDebug('Debug on. Calls will print here.');
    });
    healthBtn.addEventListener('click', () => healthCheck());

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    // --- On load: greet + health check ---
    window.addEventListener('DOMContentLoaded', () => {
      addMsg("Hi! I can answer questions about the campaign. Ask me about Zcash, wallets, or #21MWithPrivacy.", 'bot');
      inputEl.focus();
      healthCheck();
    });
  </script>
</body>
</html>
